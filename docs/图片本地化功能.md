# 📷 图片本地化功能说明

## 🎯 功能概述

生产构建时，自动下载HTML中的远程图片到本地，并替换URL为本地路径。

**适用场景：**
- 避免外链图片失效
- 提升加载速度
- 减少外部依赖
- 优化SEO

## ✨ 功能特性

### 自动化处理

✅ **自动检测**：扫描HTML中的所有图片URL  
✅ **智能下载**：只下载http/https远程图片  
✅ **自动替换**：将URL替换为本地路径  
✅ **仅生产环境**：dev模式不执行，不影响开发速度  

### 支持的图片来源

✅ `<img src="http://...">`  
✅ `background-image: url(http://...)`  
✅ `style="background: url(http://...)"`  

### 保存位置

```
dist/
  └── assets/
      └── images/
          ├── index/          ← index.html的图片
          │   ├── image_abc123.jpg
          │   └── logo_def456.png
          ├── about/          ← about.html的图片
          │   └── banner_ghi789.jpg
          └── product/        ← product.html的图片
              └── item_jkl012.png
```

## 🚀 使用方法

### 基本使用

#### 1. 在HTML中使用远程图片

```html
<!-- templates/index.html -->
<div>
  <!-- 远程图片URL -->
  <img src="https://example.com/images/banner.jpg" alt="Banner">
  
  <!-- 背景图片 -->
  <div style="background-image: url('https://example.com/bg.png')">
    内容
  </div>
</div>
```

#### 2. 运行生产构建

```bash
npm run build
```

#### 3. 查看结果

构建日志会显示：

```
处理HTML文件: dist/index.html
  检查图片URL...
  找到 2 个远程图片URL
  [1/2] 下载: https://example.com/images/banner.jpg
  ✓ 已保存: assets/images/index/banner_abc123.jpg
  [2/2] 下载: https://example.com/bg.png
  ✓ 已保存: assets/images/index/bg_def456.png
  ✓ 已替换 2 个图片URL为本地路径
✓ HTML文件处理完成: dist/index.html
```

生成的HTML：

```html
<div>
  <!-- URL已被替换为本地路径 -->
  <img src="assets/images/index/banner_abc123.jpg" alt="Banner">
  
  <div style="background-image: url('assets/images/index/bg_def456.png')">
    内容
  </div>
</div>
```

## 📁 文件命名规则

### 自动生成文件名

文件名格式：`[原始名称]_[hash].[扩展名]`

**示例：**

| 原始URL | 生成的文件名 |
|---------|-------------|
| `https://cdn.com/logo.png` | `logo_a1b2c3d4e5f6.png` |
| `https://img.com/banner.jpg` | `banner_123456789abc.jpg` |
| `https://api.com/image?id=1` | `image_fedcba987654.jpg` |

### Hash值作用

- 避免文件名冲突
- 支持文件去重（相同URL生成相同hash）
- 处理特殊字符

## 🔧 工作原理

### 处理流程

```
1. 构建HTML页面
   ↓
2. 扫描HTML内容
   ↓
3. 提取远程图片URL
   ↓
4. 创建图片保存目录：dist/assets/images/[页面名]/
   ↓
5. 下载每个图片
   ↓
6. 生成本地文件名
   ↓
7. 替换HTML中的URL
   ↓
8. 压缩优化HTML
   ↓
9. 输出最终文件
```

### 支持的URL格式

```html
<!-- ✅ 支持 -->
<img src="https://example.com/image.jpg">
<img src='http://cdn.com/photo.png'>
<img src=https://img.com/pic.gif>

<!-- ✅ 支持 -->
<div style="background-image: url('https://...')"></div>
<div style="background: url(https://...)"></div>

<!-- ❌ 不处理（已是本地路径）-->
<img src="assets/logo.png">
<img src="/static/image.jpg">
<img src="./photo.png">
```

## ⚙️ 配置选项

### 超时时间

下载超时时间：**30秒**

如需修改，编辑 `src/image-downloader.js`：

```javascript
// 设置超时（默认30000ms）
request.setTimeout(30000, () => {
  // ...
});
```

### 支持的图片格式

默认支持：
- `.jpg`, `.jpeg`
- `.png`
- `.gif`
- `.webp`
- `.svg`
- `.bmp`
- `.ico`

## 📝 示例场景

### 场景1：CDN图片本地化

**使用前：**
```html
<img src="https://cdn.example.com/products/item1.jpg">
<img src="https://cdn.example.com/products/item2.jpg">
```

**构建后：**
```html
<img src="assets/images/product/item1_a1b2c3.jpg">
<img src="assets/images/product/item2_d4e5f6.jpg">
```

### 场景2：API返回的图片URL

```html
<!-- 模板中使用API返回的图片URL -->
{{each products}}
<div class="product">
  <!-- API返回：https://img.cdn.com/product123.jpg -->
  <img src="{{$value.image}}">
</div>
{{/each}}
```

**渲染后：**
```html
<img src="https://img.cdn.com/product123.jpg">
```

**构建后：**
```html
<img src="assets/images/product/product123_abc123.jpg">
```

### 场景3：背景图片

**使用前：**
```html
<div class="hero" style="background-image: url('https://cdn.com/hero-bg.jpg')">
  Hero Section
</div>
```

**构建后：**
```html
<div class="hero" style="background-image: url('assets/images/index/hero-bg_123abc.jpg')">
  Hero Section
</div>
```

## ⚠️ 注意事项

### 1. dev模式不执行

开发模式（`npm run dev`）下：
- ❌ 不会下载图片
- ❌ 不会替换URL
- ✅ 保持原始URL，方便调试

### 2. 下载失败处理

如果图片下载失败：
- ⚠️ 显示警告信息
- ✅ 保留原始URL（不替换）
- ✅ 继续处理其他图片
- ✅ 构建不会中断

### 3. 图片去重

相同的URL只会下载一次：
- 使用MD5 hash识别
- 相同URL生成相同文件名
- 节省空间和时间

### 4. 文件大小

大图片可能导致：
- 构建时间变长
- dist目录变大
- 建议优化图片大小

## 🧪 测试验证

### 创建测试页面

创建 `templates/test-images.html`：

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>图片测试</title>
  <script src="assets/js/flexible.js"></script>
  <link rel="stylesheet" href="assets/css/mobile-adapter.css">
</head>
<body>
  <h1>图片本地化测试</h1>
  
  <!-- 测试远程图片 -->
  <img src="https://picsum.photos/400/300" alt="Random 1">
  <img src="https://picsum.photos/400/400" alt="Random 2">
  
  <!-- 测试本地图片（不会处理）-->
  <img src="assets/logo.png" alt="Local">
</body>
</html>
```

### 运行测试

```bash
# 1. 添加到config.js
{
  name: 'test-images.html',
  output: 'test-images.html'
}

# 2. 运行生产构建
npm run build

# 3. 检查结果
ls -la dist/assets/images/test-images/

# 4. 查看HTML
cat dist/test-images.html | grep "img src"
```

### 验证要点

- [ ] 远程图片已下载到 `dist/assets/images/[页面名]/`
- [ ] HTML中的URL已替换为本地路径
- [ ] 本地图片路径未改变
- [ ] 页面正常显示图片

## 🔍 故障排查

### 问题1：图片下载失败

**可能原因：**
- 网络问题
- URL失效
- 防盗链限制
- 超时

**解决方案：**
- 检查URL是否有效
- 增加超时时间
- 检查网络连接
- 查看构建日志

### 问题2：URL未被替换

**可能原因：**
- URL格式不匹配
- 图片下载失败
- HTML语法问题

**解决方案：**
- 检查URL格式是否标准
- 查看构建日志中的警告
- 确认HTML语法正确

### 问题3：生成的路径不正确

**可能原因：**
- 页面文件名特殊字符
- 路径拼接问题

**解决方案：**
- 使用标准的页面命名
- 检查生成的目录结构

## 📊 性能考虑

### 构建时间

图片下载会增加构建时间：
- 小图片（<100KB）：1-3秒/张
- 大图片（>1MB）：5-10秒/张
- 并行下载：逐个处理

### 优化建议

1. **图片优化**
   - 使用已压缩的图片
   - 控制图片大小
   - 选择合适的格式

2. **CDN使用**
   - 开发环境使用CDN
   - 生产环境下载本地

3. **缓存机制**（未来优化）
   - 已下载的图片不重复下载
   - 基于URL hash缓存

## 📋 最佳实践

### 1. 图片URL规范

```html
<!-- ✅ 推荐：使用完整URL -->
<img src="https://cdn.example.com/images/product.jpg">

<!-- ❌ 避免：协议相对URL -->
<img src="//cdn.example.com/images/product.jpg">

<!-- ❌ 避免：动态拼接URL -->
<img :src="baseUrl + imagePath">
```

### 2. 图片命名

使用有意义的文件名，方便识别：

```
https://cdn.com/product-banner.jpg  ✅
https://cdn.com/img?id=123          ❌ (会生成image_hash.jpg)
```

### 3. 本地vs远程

开发时决策：
- **频繁更新的图片**：使用远程URL
- **固定的图片**：直接放在assets目录

### 4. 大图处理

大图片建议：
- 先在本地压缩
- 使用WebP格式
- 提供多个尺寸

## 🎓 高级用法

### 批量处理

如果有大量图片需要本地化：

1. 在模板中使用远程URL
2. 运行生产构建
3. 图片自动下载和替换

### 与CDN配合

开发流程：
1. 开发时使用CDN URL（快速迭代）
2. 构建时自动本地化（稳定部署）

## 📚 相关文档

- `PRODUCTION-BUILD.md` - 生产构建说明
- `TROUBLESHOOTING.md` - 问题排查

## ✅ 功能检查清单

构建前：
- [ ] 确认图片URL可访问
- [ ] 检查网络连接
- [ ] 预估构建时间

构建后：
- [ ] 检查图片已下载
- [ ] 验证URL已替换
- [ ] 测试页面显示正常
- [ ] 检查dist目录大小

## 🔧 技术实现

### 核心模块

**`src/image-downloader.js`**
- `extractImageUrls()` - 提取图片URL
- `downloadImage()` - 下载单个图片
- `processImages()` - 批量处理
- `generateLocalFileName()` - 生成文件名

### 集成点

**`src/production-builder.js`**

在 `processHTMLFile()` 中：
```javascript
// 1. 下载图片并替换URL
content = await processImages(content, fileName, outputDir);

// 2. 移除热更新脚本
content = removeHotReloadScript(content);

// 3. 压缩HTML
content = await compressHTML(content);
```

## 📊 示例输出

### 构建日志

```
🚀 开始生产环境构建...
📄 构建页面...
✓ 页面构建完成
📁 复制静态资源...
✓ 静态资源复制完成
🔧 优化生产环境文件...

处理HTML文件: dist/index.html
  检查图片URL...
  找到 3 个远程图片URL
  [1/3] 下载: https://cdn.example.com/banner.jpg
  ✓ 已保存: assets/images/index/banner_a1b2c3.jpg
  [2/3] 下载: https://cdn.example.com/logo.png
  ✓ 已保存: assets/images/index/logo_d4e5f6.png
  [3/3] 下载: https://cdn.example.com/product.jpg
  ✓ 已保存: assets/images/index/product_g7h8i9.jpg
  ✓ 已替换 3 个图片URL为本地路径
✓ HTML文件处理完成: dist/index.html

✅ 生产环境构建完成！
```

### 生成的文件结构

```
dist/
  ├── index.html           (URL已替换)
  ├── about.html
  └── assets/
      ├── css/
      ├── js/
      └── images/           ← 新增
          ├── index/        ← index.html的图片
          │   ├── banner_a1b2c3.jpg
          │   ├── logo_d4e5f6.png
          │   └── product_g7h8i9.jpg
          ├── about/        ← about.html的图片
          │   └── team_photo_123abc.jpg
          └── product/      ← product.html的图片
              └── item_456def.png
```

## 🎯 适用场景

### ✅ 适合使用

1. **从API获取的图片URL**
   - 商品图片
   - 用户头像
   - 动态内容

2. **CDN资源**
   - Banner图
   - 广告图片
   - 第三方图片

3. **防止外链失效**
   - 长期存档的页面
   - 重要的展示页面

### ❌ 不需要使用

1. **已有本地图片**
   - 直接放在 `assets/` 目录
   - 不需要本地化

2. **实时更新的图片**
   - 用户上传的图片
   - 动态变化的内容

3. **超大图片**
   - 视频封面
   - 高清大图（建议手动优化）

## 💡 提示

### dev模式

开发时使用远程URL，方便快速迭代：

```html
<!-- 开发时 -->
<img src="https://cdn.com/temp-image.jpg">

<!-- 运行 npm run dev -->
<!-- 图片直接从远程加载 -->
```

### 生产构建

生产构建时自动本地化：

```bash
# 运行生产构建
npm run build

# 图片自动下载到本地
# URL自动替换
```

## 🎉 总结

✅ **自动化**：无需手动下载图片  
✅ **智能化**：只处理远程图片  
✅ **稳定性**：避免外链失效  
✅ **性能**：本地加载更快  
✅ **开发友好**：dev模式不影响速度  

**生产构建时自动处理，开发时保持原样！** 🚀

---

**使用方法：**
1. 模板中使用远程图片URL
2. 运行 `npm run build`
3. 图片自动下载并替换
4. 部署dist目录即可

